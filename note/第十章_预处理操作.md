# 第十章 预处理操作

C与处理器不是编译器的组成部分，但是它是编译过程中的一个单独的步骤，简言之，C预处理器只是一个文本替换工具，会指示编译在实际编译之前完成所需的预处理。

下面是一个预处理指令的例子：

```C
#ifdef DEBUG
    printf("Debug 模式开启！\n");
#endif
```

## 所有的预处理指令

| 预处理指令 | 解释 |
| --- | --- |
| `#include` | 用于包含头文件 |
| `#define` | 用于定义宏 |
| `#undef` | 用于取消已定义的宏 |
| `#ifdef` | 如果宏已经定义，则返回真 |
| `#ifndef` | 如果宏没有定义，则返回真 |
| `#if` | 如果给定条件为真，则编译下面的代码 |
| `#else` | 与`#if`配合使用，当`#if`的条件为假时，编译`#else`后面的代码 |
| `#elif` | 与`#if`配合使用，当`#if`的条件为假时，检查`#elif`的条件 |
| `#endif` | 结束`#if`，`#else`或`#elif`的代码块 |
| `#error` | 当遇到标准错误时，输出错误消息 |
| `#pragma` | 用于向编译器发送特殊的命令或请求 |

### `#pragma`指令

`#pragma`指令是一种特殊的预处理器指令，用于向编译器发送特殊的命令或请求。`#pragma`指令的具体行为取决于其后面的参数，这些参数是编译器特定的。

例如，`#pragma once`是一个常见的`#pragma`指令，它会确保头文件只被包含一次，以防止重复定义。这是一个非标准但广泛支持的预处理器指令，用于代替传统的头文件保护技术，如下所示：

```C
#ifndef HEADER_FILE
#define HEADER_FILE
// 头文件内容
#endif
```

另一个常见的`#pragma`指令是`#pragma pack(n)`，它用于控制结构体和联合体的对齐方式。例如，`#pragma pack(1)`会设置结构体和联合体的对齐方式为1字节对齐。

需要注意的是，`#pragma`指令是非标准的，不同的编译器可能会支持不同的`#pragma`指令。

因此，在使用`#pragma`指令时，应确保你的代码在目标编译器上能够正确工作。

### 预处理器的一些实例

## 宏

宏是预处理器的一个重要功能，它允许你定义一些文本，然后在程序中多次使用。例如：

```C
#define MAX 100
```

这个例子中定义了一个宏，名为`MAX`，值为`100`。可以在程序中使用`MAX`，就像它是一个常量一样。

### 预定义宏

C预处理器提供了一些预定义的宏，可以在程序中直接使用。

| 预定义宏 | 描述 |
| -------- | ---- |
| `__DATE__` | 当前日期，一个字符串常量，格式为 "Mmm dd yyyy" |
| `__TIME__` | 当前时间，一个字符串常量，格式为 "hh:mm:ss" |
| `__FILE__` | 这会包含当前文件名，一个字符串常量 |
| `__LINE__` | 这会包含当前行号，一个整型常量 |
| `__STDC__` | 如果编译器遵循 ANSI C，该标识被赋值为 1 |

### 预处理器运算符

C预处理器提供了一些运算符，用于在预处理阶段进行操作。

| 预处理器运算符 | 描述 |
| -------------- | ---- |
| `#` | 把宏参数转换为一个字符串常量 |
| `##` | 连接两个令牌 |
| `defined()` | 如果已定义了宏，则返回真（1） |
| `#include` | 插入一个头文件 |
| `#define` | 定义一个预处理宏 |
| `#undef` | 取消已定义的宏 |
| `#ifdef` | 如果宏已经定义，则返回真 |
| `#ifndef` | 如果宏没有定义，则返回真 |
| `#if` | 如果给定条件为真，则编译下面代码 |
| `#else` | 如果上面的 `#if` 给定条件不为真，则编译下面代码 |
| `#elif` | 如果上面的 `#if` 或 `#ifdef` 给定条件不为真，这个条件如果为真，则编译下面代码 |
| `#endif` | 结束一个 `#if`、`#ifdef`、`#ifndef` 或 `#elif` 的块 |

### 宏函数

宏也可以定义为函数，这被称为宏函数。例如：

```C
#define SQUARE(x) ((x) * (x))
```

这个例子中定义了一个宏函数，名为`SQUARE`，接受一个参数`x`，并返回`x`的平方。

在宏函数中需要注意分号问题，因为宏本质上是文本替换，所以宏函数末尾可以有也可以没有分号，看实际位置决定是否需要添加分号。

### 由宏实现的一个简单的“中文编程”

```C
#define 主 main
#define 整 int
#define 左小括 (
#define 右小括 )
#define 左大括 {
#define 右大括 }
#define 打印 printf
#define 分 ;
#define 换行 "\n"
#define 返回 return
#define 零 0

整 主 左小括 右小括
左大括
    打印 左小括 "你好世界！" 右小括 分
    打印 左小括 换行 右小括 分
    返回 零 分
右大括
```

